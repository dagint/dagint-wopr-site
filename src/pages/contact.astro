---
import Layout from '@/layouts/Layout.astro';
// Contact info and form config from env (set in Cloudflare Pages → Settings → Environment variables).
// Obfuscated in output: base64 decoded in browser so scrapers don't see plain email/phone in HTML.
const contactEmail = import.meta.env.PUBLIC_CONTACT_EMAIL ?? '';
const contactPhone = import.meta.env.PUBLIC_CONTACT_PHONE ?? '';
const emailB64 = contactEmail ? Buffer.from(contactEmail, 'utf-8').toString('base64') : '';
const phoneB64 = contactPhone ? Buffer.from(contactPhone.replace(/\s/g, ''), 'utf-8').toString('base64') : '';
const formId = import.meta.env.PUBLIC_FORMSPREE_FORM_ID ?? '';
const formAction = formId ? `https://formspree.io/f/${formId}` : '#';
const thanksUrl = `${import.meta.env.SITE ?? 'https://dagint.com'}/contact/thanks`;
const turnstileSiteKey = import.meta.env.PUBLIC_TURNSTILE_SITE_KEY ?? '1x00000000000000000000AA';
---

<Layout title="Contact">
  <section class="page-banner flex items-end pb-8 sm:pb-10">
    <div class="absolute inset-0 opacity-40" aria-hidden="true">
      <svg class="w-full h-full" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <pattern id="wopr-grid-contact" width="32" height="32" patternUnits="userSpaceOnUse">
            <circle cx="16" cy="16" r="2" fill="var(--wopr-accent)" />
          </pattern>
        </defs>
        <rect width="100%" height="100%" fill="url(#wopr-grid-contact)" />
      </svg>
    </div>
    <div class="relative z-10 max-w-5xl mx-auto px-4 sm:px-6 w-full">
      <h1 class="page-title-on-banner">Contact</h1>
      <p class="mt-2 text-white/95 text-sm sm:text-base max-w-xl">
        Reach out for a quote or to schedule support. We’ll get back to you promptly.
      </p>
    </div>
  </section>

  <div class="page-section max-w-xl">
    <div class="flex justify-center mb-8" aria-hidden="true">
      <div class="w-24 h-24 rounded-2xl bg-[var(--wopr-primary)]/10 flex items-center justify-center p-4">
        <svg class="w-12 h-12 text-[var(--wopr-accent)]" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><path d="m22 6-10 7L2 6"/></svg>
      </div>
    </div>
    <div class="card p-5 sm:p-6 mb-8 border-l-4 border-l-[var(--wopr-accent)]">
      <h2 class="text-sm font-semibold text-[var(--wopr-secondary)] uppercase tracking-wider mb-3">Contact information</h2>
      <dl class="space-y-3 text-sm">
        <div>
          <dt class="text-gray-600">Email</dt>
          <dd><a id="contact-email" href="#" class="text-[var(--wopr-accent)] font-medium hover:underline break-all">Loading…</a></dd>
        </div>
        <div>
          <dt class="text-gray-600">Phone</dt>
          <dd><a id="contact-phone" href="#" class="text-[var(--wopr-accent)] font-medium hover:underline">Loading…</a></dd>
        </div>
      </dl>
    </div>

    <div class="card p-5 sm:p-6 border-l-4 border-l-[var(--wopr-secondary)]/60">
      <h2 class="text-sm font-semibold text-[var(--wopr-secondary)] uppercase tracking-wider mb-4">Send a message</h2>
      <form action={formAction} method="POST" class="space-y-4">
        <input type="text" name="_gotcha" class="hidden" tabindex="-1" autocomplete="off" />
        <input type="hidden" name="_next" value={thanksUrl} />
        <div>
          <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Name</label>
          <input type="text" id="name" name="name" required class="w-full px-3 py-2.5 rounded-md border border-gray-300 text-gray-800 placeholder-gray-400 focus:ring-2 focus:ring-[var(--wopr-accent)] focus:border-transparent" placeholder="Your name" />
        </div>
        <div>
          <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
          <input type="email" id="email" name="email" required class="w-full px-3 py-2.5 rounded-md border border-gray-300 text-gray-800 placeholder-gray-400 focus:ring-2 focus:ring-[var(--wopr-accent)] focus:border-transparent" placeholder="you@example.com" />
        </div>
        <div>
          <label for="message" class="block text-sm font-medium text-gray-700 mb-1">Message</label>
          <textarea id="message" name="message" rows="4" required class="w-full px-3 py-2.5 rounded-md border border-gray-300 text-gray-800 placeholder-gray-400 focus:ring-2 focus:ring-[var(--wopr-accent)] focus:border-transparent resize-y" placeholder="How can we help?"></textarea>
        </div>
        <div class="cf-turnstile" data-sitekey={turnstileSiteKey} data-theme="light"></div>
        <button type="submit" class="inline-flex items-center px-5 py-2.5 rounded-md text-sm font-medium text-white bg-[var(--wopr-primary)] hover:bg-[var(--wopr-secondary)] transition-colors">
          Send message
        </button>
      </form>
    </div>
  </div>

  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  <script define:vars={{ emailB64, phoneB64 }}>
    (function () {
      try {
        const email = atob(emailB64);
        const phone = atob(phoneB64);
        const emailEl = document.getElementById('contact-email');
        const phoneEl = document.getElementById('contact-phone');
        if (emailEl) { emailEl.href = 'mailto:' + email; emailEl.textContent = email; }
        if (phoneEl) { phoneEl.href = 'tel:' + phone.replace(/\D/g, ''); phoneEl.textContent = phone; }
      } catch (_) {}
    })();
  </script>
</Layout>
