---
import Layout from '@/layouts/Layout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog', (p) => p.data.published !== false);
  return posts.map((entry) => ({ params: { slug: entry.slug }, props: { entry } }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();
const site = Astro.site ?? 'https://dagint.com';
const canonical = new URL(`/blog/${entry.slug}`, site);
const blogLd = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: entry.data.title,
  description: entry.data.summary,
  datePublished: entry.data.date.toISOString(),
  url: canonical.toString(),
};
---

<Layout title={entry.data.title} description={entry.data.summary}>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify(blogLd)} />
    <link rel="canonical" href={canonical.toString()} />
  </Fragment>

  <section class="page-banner flex items-end pb-8 sm:pb-10">
    <div class="absolute inset-0 opacity-40" aria-hidden="true">
      <svg class="w-full h-full" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <pattern id="wopr-grid-post" width="32" height="32" patternUnits="userSpaceOnUse">
            <circle cx="16" cy="16" r="2" fill="var(--wopr-accent)" />
          </pattern>
        </defs>
        <rect width="100%" height="100%" fill="url(#wopr-grid-post)" />
      </svg>
    </div>
    <div class="relative z-10 max-w-5xl mx-auto px-4 sm:px-6 w-full">
      <h1 class="page-title-on-banner">{entry.data.title}</h1>
      <p class="mt-2 text-white/95 text-sm sm:text-base max-w-2xl">{entry.data.summary}</p>
      <time class="block mt-3 text-xs text-blue-200" datetime={entry.data.date.toISOString()}>
        {entry.data.date.toLocaleDateString('en-AU', { year: 'numeric', month: 'long', day: 'numeric' })}
      </time>
    </div>
  </section>

  <div class="page-section max-w-3xl mx-auto">
    <article class="blog-post prose prose-slate prose-lg max-w-none prose-headings:font-mono prose-headings:text-[var(--wopr-primary)] prose-headings:scroll-mt-24 prose-a:text-[var(--wopr-secondary)] prose-a:no-underline hover:prose-a:underline prose-a:font-medium prose-p:leading-relaxed prose-ul:my-6 prose-ol:my-6 prose-li:my-1">
      <Content />
    </article>
    <p class="mt-10">
      <a href="/blog" class="text-sm font-medium text-[var(--wopr-accent)] hover:underline">← Back to blog</a>
      <span class="mx-2 text-gray-400">·</span>
      <a href="/contact" class="text-sm font-medium text-[var(--wopr-accent)] hover:underline">Get in touch</a>
    </p>
  </div>
</Layout>
